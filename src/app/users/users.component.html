<app-header></app-header>
<app-sidebar></app-sidebar>
<p-toast></p-toast>
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="add-item d-flex">
                <div class="page-title">
                    <h4>Utilisateurs</h4>
                    <h6>Gérez vos utilisateurs</h6>
                </div>
            </div>
            <ul class="table-top-head">
                <li>
                    <div class="d-flex me-2 pe-2 border-end">
                        <a href="employees-grid.html" class="btn-grid active bg-primary me-2"><i data-feather="grid" class="feather-user text-white"></i></a>
                    </div>
                </li>
                <li class="me-2">
                    <a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf"><img src="assets/img/icons/pdf.svg" alt="img"></a>
                </li>
                <li class="me-2">
                    <a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel"><img src="assets/img/icons/excel.svg" alt="img"></a>
                </li>
                <li class="me-2">
                    <a data-bs-toggle="tooltip" data-bs-placement="top" title="Rafraîchir"><i class="ti ti-refresh"></i></a>
                </li>
                <li class="me-2">
                    <a data-bs-toggle="tooltip" data-bs-placement="top" title="Réduire" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
                </li>
            </ul>
            <div class="page-btn">
                <button class="btn btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#edit-customer" (click)="openAddUserModal()">
                    <i class="ti ti-circle-plus me-1"></i>Ajouter un utilisateur
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-purple border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <p class="mb-1 text-white">Utilisateurs chargés</p>
                            <h4 class="text-white">{{ (users?.length || 0) < 10 ? '0' + (users?.length || 0) : (users?.length || 0) }}</h4>
                        </div>
                        <div>
                            <span class="avatar avatar-lg bg-purple-900"><i class="ti ti-users-group"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-teal border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <p class="mb-1 text-white">Actifs</p>
                            <h4 class="text-white">{{ activeUsersCount }}</h4>
                        </div>
                        <div>
                            <span class="avatar avatar-lg bg-teal-900"><i class="ti ti-user-star"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-secondary border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <p class="mb-1 text-white">Inactifs</p>
                            <h4 class="text-white">{{ inactiveUsersCountFormatted }}</h4>
                        </div>
                        <div>
                            <span class="avatar avatar-lg bg-secondary-900"><i class="ti ti-user-exclamation"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-info border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <p class="mb-1 text-white">Super Admins</p>
                            <h4 class="text-white">{{ superAdminCount }}</h4>
                        </div>
                        <div>
                            <span class="avatar avatar-lg bg-info-900"><i class="ti ti-user-check"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap row-gap-3">
                    <div class="search-set mb-0">
                        <div class="search-input">
                            <span class="btn-searchset"><i class="ti ti-search fs-14 feather-search"></i></span>
                            <input
                                type="search"
                                class="form-control"
                                placeholder="Rechercher par tous...."
                                [(ngModel)]="searchTerm"
                                (input)="filterUsers()"
                            >
                        </div>
                    </div>
                    <div class="d-flex table-dropdown my-xl-auto right-content align-items-center flex-wrap row-gap-3">
                        <div class="dropdown me-2">
                            <a href="javascript:void(0);" class="dropdown-toggle btn btn-white btn-md d-inline-flex align-items-center" data-bs-toggle="dropdown">
                                Fonction
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end p-3">
                                <li>
                                    <a href="javascript:void(0);" class="dropdown-item rounded-1" (click)="roleFilter = null; filterUsers()">Tous</a>
                                </li>
                                <li *ngFor="let role of roles">
                                    <a href="javascript:void(0);" class="dropdown-item rounded-1" (click)="roleFilter = role.id; filterUsers()">{{ role.name }}</a>
                                </li>
                            </ul>
                        </div>
                        <div class="dropdown me-2">
                            <a href="javascript:void(0);" class="dropdown-toggle btn btn-white btn-md d-inline-flex align-items-center" data-bs-toggle="dropdown">
                                Statut
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end p-3">
                                <li>
                                    <a href="javascript:void(0);" class="dropdown-item rounded-1" (click)="statusFilter = null; filterUsers()">Tous</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" class="dropdown-item rounded-1" (click)="statusFilter = 'active'; filterUsers()">Actif</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" class="dropdown-item rounded-1" (click)="statusFilter = 'inactive'; filterUsers()">Inactif</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="employee-grid-widget">
            <div class="row">
                <ng-container *ngIf="(filteredUsers?.length || 0) > 0; else noUsers">
                    <div class="col-xxl-3 col-xl-4 col-lg-6 col-md-6" *ngFor="let user of filteredUsers">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between mb-2">
                                    <div class="form-check form-check-md">
                                        <p-tag [ngStyle]="{'font-size': '0.65rem'}"
                                               [value]="user.deleted_at ? 'Inactif' : 'Actif'" 
                                               [severity]="user.deleted_at ? 'danger' : 'success'">
                                        </p-tag>
                                    </div>
                                    <div>
                                        <span class="avatar avatar-xl avatar-rounded border p-1 rounded-circle bg-success text-white d-flex align-items-center justify-content-center fs-4" style="width:48px; height:48px;">
                                            {{ (user.first_name ? user.first_name.charAt(0) : '') + (user.last_name ? user.last_name.charAt(0) : '') }}
                                        </span>
                                    </div>
                                    <div class="dropdown" style="padding-right: 1rem !important;">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="dropdown">
                                                <a href="#" class="action-icon border-0" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-vertical feather-user">
                                                        <circle cx="12" cy="12" r="1"></circle>
                                                        <circle cx="12" cy="5" r="1"></circle>
                                                        <circle cx="12" cy="19" r="1"></circle>
                                                    </svg>
                                                </a>
                                                <ul class="dropdown-menu dropdown-menu-end ">
                                                    <li>
                                                        <a href="#" data-bs-toggle="modal" data-bs-target="#edit-customer" (click)="openEditUserModal(user)" class="dropdown-item">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit me-2">
                                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                            </svg>Modifier
                                                        </a>
                                                    </li>
                                                    <li *ngIf="!user.deleted_at">
                                                        <a href="#" data-bs-toggle="modal" data-bs-target="#delete-modal" class="dropdown-item confirm-text mb-0" (click)="openDeleteUserModal(user)">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2 me-2">
                                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                                            </svg>Supprimer
                                                        </a>
                                                    </li>	
                                                    <li *ngIf="user.deleted_at">
                                                        <a href="#" data-bs-toggle="modal" data-bs-target="#reactivate-modal" class="dropdown-item" (click)="openReactivateUserModal(user)">
                                                            <i class="ti ti-user-check me-2"></i>Réactiver
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <p class="text-primary mb-2">ID : {{ user.id }}</p>
                                </div>
                                <div class="text-center mb-3">
                                    <h6 class="mb-1"><a href="employee-details.html">{{ user.full_name || (user.first_name + ' ' + user.last_name) }}</a></h6>
                                    <span class="badge bg-secondary-transparent text-gray-9 fs-10 fw-medium">{{ user.email || 'Email non renseigné' }}</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-between bg-light rounded p-3">
                                    <div class="text-start">
                                        <h6 class="mb-1">Date d'inscription</h6>
                                        <p>{{ user.created_at | date:'dd/MM/yyyy' }}</p>
                                    </div>
                                    <div class="text-start">
                                        <h6 class="mb-1">Rôle</h6>
                                        <p>{{ user.role_name }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ng-container>
                <ng-template #noUsers>
                    <div class="col-12 text-center py-5">
                        <span class="text-muted">Aucun utilisateur trouvé.</span>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
    <app-footer></app-footer>
</div>

<!-- Edit/Add Customer -->
<div class="modal fade" id="edit-customer">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="page-wrapper-new p-0">
                <div class="content">
                    <div class="modal-header">
                        <div class="page-title">
                            <h4>{{ selectedUser?.id ? 'Modifier Utilisateur' : 'Ajouter Utilisateur' }}</h4>
                        </div>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form (ngSubmit)="saveUserChanges()">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Prénom<span class="text-danger ms-1">*</span></label>
                                    <input type="text" class="form-control" [(ngModel)]="selectedUser.first_name" name="first_name" required>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Nom<span class="text-danger ms-1">*</span></label>
                                    <input type="text" class="form-control" [(ngModel)]="selectedUser.last_name" name="last_name" required>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Téléphone</label>
                                    <input type="tel" class="form-control" [(ngModel)]="selectedUser.telephone" name="telephone">
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Rôle</label>
                                    <p-dropdown [options]="roles" [(ngModel)]="selectedUser.role_id" optionLabel="name" optionValue="id" name="role_id" placeholder="Sélectionner un rôle"></p-dropdown>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Email<span class="text-danger ms-1">*</span></label>
                                    <input type="email" class="form-control" [(ngModel)]="selectedUser.email" name="email" required>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Mot de passe <span class="text-danger ms-1">*</span></label>
                                    <p-password 
                                        [(ngModel)]="selectedUser.password" 
                                        name="password" 
                                        [toggleMask]="true" 
                                        [style.display]="'grid'"
                                        inputStyleClass="form-control w-100">
                                    </p-password>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Confirmer le mot de passe <span class="text-danger ms-1">*</span></label>
                                    <p-password 
                                        [(ngModel)]="selectedUser.confirmPassword" 
                                        name="confirmPassword" 
                                        [toggleMask]="true" 
                                        [style.display]="'grid'"
                                        inputStyleClass="form-control w-100">
                                    </p-password>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Ville</label>
                                    <p-autoComplete 
                                        [(ngModel)]="selectedUser.city" 
                                        name="city"
                                        [suggestions]="filteredCities"
                                        (completeMethod)="filterCities($event)"
                                        field="nom"
                                        [forceSelection]="true"
                                        optionLabel="nom"
                                        (onSelect)="onCitySelected($event)"
                                        (onChange)="onCityChange()"
                                        placeholder="Rechercher une ville...">
                                    </p-autoComplete>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Code postal</label>
                                    <input type="text" class="form-control" [(ngModel)]="selectedUser.code_postal" name="code_postal" readonly>
                                </div>
                                <div class="col-lg-12 mb-3">
                                    <label class="form-label">Type d'appareil</label>
                                    <p-dropdown 
                                        [options]="deviceTypes" 
                                        [(ngModel)]="selectedUser.device_type" 
                                        name="device_type" 
                                        optionLabel="label" 
                                        optionValue="value" 
                                        placeholder="Sélectionner un appareil">
                                    </p-dropdown>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn me-2 btn-secondary fs-13 fw-medium p-2 px-3 shadow-none" data-bs-dismiss="modal" (click)="closeEditUserModal()">Annuler</button>
                            <button type="submit" class="btn btn-primary fs-13 fw-medium p-2 px-3">
                                {{ selectedUser?.id ? 'Enregistrer' : 'Ajouter' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="delete-modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="page-wrapper-new p-0">
                <div class="content p-5 px-3 text-center">
                    <span class="rounded-circle d-inline-flex p-2 bg-danger-transparent mb-2"><i class="ti ti-trash fs-24 text-danger"></i></span>
                    <h4 class="fs-20 fw-bold mb-2 mt-1">Supprimer Utilisateur</h4>
                    <p class="mb-0 fs-16">Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
                    <div class="modal-footer-btn mt-3 d-flex justify-content-center">
                        <button type="button" class="btn me-2 btn-secondary fs-13 fw-medium p-2 px-3 shadow-none" data-bs-dismiss="modal" (click)="closeDeleteUserModal()">Annuler</button>
                        <button type="button" class="btn btn-primary fs-13 fw-medium p-2 px-3" (click)="deleteUser()">Oui, Supprimer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal confirmation for reactivation -->
<div class="modal fade" id="reactivate-modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="page-wrapper-new p-0">
                <div class="content p-5 px-3 text-center">
                    <span class="rounded-circle d-inline-flex p-2 bg-success-transparent mb-2"><i class="ti ti-user-check fs-24 text-success"></i></span>
                    <h4 class="fs-20 fw-bold mb-2 mt-1">Réactiver Utilisateur</h4>
                    <p class="mb-0 fs-16">Êtes-vous sûr de vouloir réactiver cet utilisateur ?</p>
                    <div class="modal-footer-btn mt-3 d-flex justify-content-center">
                        <button type="button" class="btn me-2 btn-secondary fs-13 fw-medium p-2 px-3 shadow-none" data-bs-dismiss="modal" (click)="closeReactivateUserModal()">Annuler</button>
                        <button type="button" class="btn btn-success fs-13 fw-medium p-2 px-3" (click)="reactivateUser()">Oui, Réactiver</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>